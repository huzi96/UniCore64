From 0c906ffad5a50df12868db70b09a6b1a9e28fed4 Mon Sep 17 00:00:00 2001
From: Liu Guoli <liuguoli@mprc.pku.edu.cn>
Date: Sat, 10 Dec 2011 21:43:56 +0800
Subject: [PATCH 153/641] UniCore64: Add setup_arch()

Signed-off-by: Liu Guoli <liuguoli@mprc.pku.edu.cn>
---
 arch/unicore64/include/asm/setup_arch.h |    3 +++
 arch/unicore64/kernel/cpu-uc64.c        |    6 +++++
 arch/unicore64/kernel/setup.c           |   39 +++++++++++++++++++++++++++++--
 arch/unicore64/mm/init.c                |    6 +++++
 4 files changed, 52 insertions(+), 2 deletions(-)

diff --git a/arch/unicore64/include/asm/setup_arch.h b/arch/unicore64/include/asm/setup_arch.h
index ddcac3c..45cdb7d 100644
--- a/arch/unicore64/include/asm/setup_arch.h
+++ b/arch/unicore64/include/asm/setup_arch.h
@@ -4,6 +4,9 @@
 #include <linux/stringify.h>
 #include <arch/hwdef-copro.h>
 
+extern void setup_arch_cpuinfo(void);
+extern void setup_arch_memory(void);
+
 #define UC64_CPUID							\
 	({								\
 		unsigned long __val;					\
diff --git a/arch/unicore64/kernel/cpu-uc64.c b/arch/unicore64/kernel/cpu-uc64.c
index cb5e335..b84d23c 100644
--- a/arch/unicore64/kernel/cpu-uc64.c
+++ b/arch/unicore64/kernel/cpu-uc64.c
@@ -1,6 +1,12 @@
 #include <linux/kernel.h>
 #include <linux/seq_file.h>
 
+void __init setup_arch_cpuinfo(void)
+{
+	/* FIXME */
+	BUG();
+}
+
 /**
  * cpu_uc64_show() - show the UniCore64 cpu information
  * @m:		sequence file to output
diff --git a/arch/unicore64/kernel/setup.c b/arch/unicore64/kernel/setup.c
index 052b47c..2e24577 100644
--- a/arch/unicore64/kernel/setup.c
+++ b/arch/unicore64/kernel/setup.c
@@ -1,5 +1,34 @@
 #include <linux/kernel.h>
 #include <linux/init.h>
+#include <linux/notifier.h>
+
+#include <asm/setup_arch.h>
+
+static int uc64_panic_event(struct notifier_block *this,
+		unsigned long event, void *ptr)
+{
+	/* FIXME */
+	pr_emerg("Kernel OOPS in %s", __func__);
+	return NOTIFY_DONE;
+}
+
+static struct notifier_block uc64_panic_block = {
+	uc64_panic_event,
+	NULL,
+	INT_MAX /* try to do it first */
+};
+
+static void __init setup_arch_param(char **cmdline_p)
+{
+	/* FIXME */
+	BUG();
+}
+
+static void __init setup_arch_resource(void)
+{
+	/* FIXME */
+	BUG();
+}
 
 /**
  * setup_arch() - Architecture-specific boot-time initializations
@@ -7,6 +36,12 @@
  */
 void __init setup_arch(char **cmdline_p)
 {
-	/* FIXME */
-	BUG();
+	/* Register a call for panic conditions. */
+	atomic_notifier_chain_register(&panic_notifier_list,
+			&uc64_panic_block);
+
+	setup_arch_cpuinfo();
+	setup_arch_param(cmdline_p);
+	setup_arch_memory();
+	setup_arch_resource();
 }
diff --git a/arch/unicore64/mm/init.c b/arch/unicore64/mm/init.c
index ddb7a60..092195c 100644
--- a/arch/unicore64/mm/init.c
+++ b/arch/unicore64/mm/init.c
@@ -17,3 +17,9 @@ void free_initmem(void)
 	/* FIXME */
 	BUG();
 }
+
+void __init setup_arch_memory(void)
+{
+	/* FIXME */
+	BUG();
+}
-- 
1.7.9.5

