From d8694f7d09ac9b782e067f3578bdae5f6f00b681 Mon Sep 17 00:00:00 2001
From: Yu Yue <yuyue@mprc.pku.edu.cn>
Date: Wed, 14 Dec 2011 15:08:39 +0800
Subject: [PATCH 167/641] UniCore64: add boot head

Signed-off-by: Yu Yue <yuyue@mprc.pku.edu.cn>
---
 arch/unicore64/boot/boot-head.S |   61 +++++++++++++++++++++++++++++++++++++++
 1 file changed, 61 insertions(+)
 create mode 100644 arch/unicore64/boot/boot-head.S

diff --git a/arch/unicore64/boot/boot-head.S b/arch/unicore64/boot/boot-head.S
new file mode 100644
index 0000000..e5e1f39
--- /dev/null
+++ b/arch/unicore64/boot/boot-head.S
@@ -0,0 +1,61 @@
+#include <arch/hwdef-memory.h>
+#include <arch/hwdef-copro.h>
+#include <arch/asm-common.h>
+#include <arch/asm-mmuops.h>
+#include <arch/head-macros.S>
+
+	.section ".start"
+start:
+	/*
+	 * Initialize ASR and coprocessor 0.
+	 */
+	__head_initialize	r0
+
+	/*
+	 * Initialise TLB and Caches.
+	 */
+	uc64_invalidate_dcache	r0
+	uc64_invalidate_icache	r0
+	uc64_invalidate_tlb	r0
+
+	/*
+	 * Turn on dcache and icache.
+	 */
+	uc64_enable_cache	r0
+
+	/*
+	 * Set the sp register.
+	 */
+	dmovl	sp, #UC64_PM_ZIMAGE_SP
+
+	/*
+	 * Clear BSS region.
+	 */
+	__head_clear_bss
+
+	/*
+	 * Call decompress_kernel, and it's three parameters are:
+	 *   r0: output_start
+	 *   r1: free_mem_ptr_p
+	 *   r2: free_mem_ptr_end_p
+	 */
+	dmovl	r0, #UC64_PM_KIMAGE_START
+	dmovl	r1, #UC64_PM_ZIMAGE_SP
+	dmovl	r2, #UC64_PM_ZIMAGE_HEAP
+	call	decompress_kernel
+
+	/*
+	 * Flush the cache to maintain consistency.
+	 */
+	uc64_flush_dcache	r0
+
+	/*
+	 * Initialize ASR and coprocessor 0.
+	 */
+	__head_initialize	r0
+
+	/*
+	 * Jump to the start address of kernel image.
+	 */
+	dmovl	r0, #UC64_VM_KIMAGE_START
+	jump	r0
-- 
1.7.9.5

