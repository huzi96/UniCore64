From 0667349ddcfd8b6590e7802bf28a403fe1626a86 Mon Sep 17 00:00:00 2001
From: GuanXuetao <gxt@mprc.pku.edu.cn>
Date: Fri, 16 Dec 2011 10:20:02 +0800
Subject: [PATCH 172/641] UniCore64: add boot compilation support

Signed-off-by: yuyue <yuyue@mprc.pku.edu.cn>
Signed-off-by: GuanXuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/.gitignore       |    6 ++++++
 arch/unicore64/Makefile         |   11 ++++++++++-
 arch/unicore64/boot/Makefile    |   34 ++++++++++++++++++++++++++++++++++
 arch/unicore64/boot/boot-head.S |    3 +++
 arch/unicore64/boot/boot.lds.S  |    6 +++++-
 5 files changed, 58 insertions(+), 2 deletions(-)
 create mode 100644 arch/unicore64/boot/Makefile

diff --git a/arch/unicore64/.gitignore b/arch/unicore64/.gitignore
index c3fe956..dacae48 100644
--- a/arch/unicore64/.gitignore
+++ b/arch/unicore64/.gitignore
@@ -2,3 +2,9 @@
 # Generated ld script file
 #
 kernel/vmlinux.lds
+#
+# Generated files in boot
+#
+boot/boot.lds
+boot/Image
+boot/zImage
diff --git a/arch/unicore64/Makefile b/arch/unicore64/Makefile
index 7a90d9c..a98f6c1 100644
--- a/arch/unicore64/Makefile
+++ b/arch/unicore64/Makefile
@@ -34,7 +34,15 @@ core-y			+= arch/unicore64/mm/
 
 libs-y			+= arch/unicore64/lib/
 
-all:	vmlinux
+all:	zImage
+
+BOOT_DIR		:= arch/unicore64/boot/
+
+zImage: vmlinux
+	$(Q)$(MAKE) $(build)=$(BOOT_DIR) $(BOOT_DIR)/$@
+
+archclean:
+	$(Q)$(MAKE) $(clean)=$(BOOT_DIR)
 
 DOC_DIR			:= Documentation/DocBook
 archdoc:
@@ -44,4 +52,5 @@ archdoc:
 define archhelp
 	echo  '  defconfig     - Use arch/$(ARCH)/configs/$(KBUILD_DEFCONFIG)'
 	echo  '  archdoc       - Generate $(DOC_DIR)/unicore64-kernel.pdf'
+	echo  ' *zImage        - Compressed kernel image (arch/$(ARCH)/boot/zImage)'
 endef
diff --git a/arch/unicore64/boot/Makefile b/arch/unicore64/boot/Makefile
new file mode 100644
index 0000000..59438c3
--- /dev/null
+++ b/arch/unicore64/boot/Makefile
@@ -0,0 +1,34 @@
+# All targets during boot
+targets		:= Image piggy.bin boot.lds boot.bin zImage
+
+# Do not recognize built-in functions in uncompress.c
+EXTRA_CFLAGS	:= -fno-builtin
+
+$(obj)/Image: vmlinux FORCE
+	$(call if_changed,objcopy)
+	@echo '  Kernel: $@ is ready'
+
+# Compress Image Method
+suffix_$(CONFIG_KERNEL_GZIP)	:= gzip
+suffix_$(CONFIG_KERNEL_BZIP2)	:= bz2
+suffix_$(CONFIG_KERNEL_LZO)	:= lzo
+suffix_$(CONFIG_KERNEL_LZMA)	:= lzma
+
+$(obj)/piggy.bin: $(obj)/Image FORCE
+	$(call if_changed,$(suffix_y))
+
+$(obj)/boot-head.o: $(obj)/piggy.bin
+
+BOOT_OBJS	:= $(srctree)/arch/unicore64/lib/memcpy.o
+BOOT_OBJS	+= $(srctree)/arch/unicore64/lib/memset.o
+BOOT_OBJS	+= $(srctree)/arch/unicore64/lib/wordcopy.o
+BOOT_OBJS	+= $(srctree)/arch/unicore64/lib/debug.o
+BOOT_OBJS	+= $(obj)/uncompress.o
+
+$(obj)/boot.bin: $(obj)/boot.lds $(obj)/boot-head.o $(BOOT_OBJS) FORCE
+	$(call if_changed,ld)
+	@:
+
+$(obj)/zImage: $(obj)/boot.bin FORCE
+	$(call if_changed,objcopy)
+	@echo '  Kernel: $@ is ready'
diff --git a/arch/unicore64/boot/boot-head.S b/arch/unicore64/boot/boot-head.S
index e5e1f39..d173007 100644
--- a/arch/unicore64/boot/boot-head.S
+++ b/arch/unicore64/boot/boot-head.S
@@ -59,3 +59,6 @@ start:
 	 */
 	dmovl	r0, #UC64_VM_KIMAGE_START
 	jump	r0
+
+	.section .piggydata
+	.incbin "arch/unicore64/boot/piggy.bin"
diff --git a/arch/unicore64/boot/boot.lds.S b/arch/unicore64/boot/boot.lds.S
index b4e2d1c..c9aef20 100644
--- a/arch/unicore64/boot/boot.lds.S
+++ b/arch/unicore64/boot/boot.lds.S
@@ -24,7 +24,11 @@ SECTIONS
     *(.text)
     *(.rodata)
     *(.rodata.*)
-    *(.piggydata)
+
+		input_data = .;
+		*(.piggydata)
+		input_data_end = .;
+
     . = ALIGN(4);
   }
   _etext = .;
-- 
1.7.9.5

