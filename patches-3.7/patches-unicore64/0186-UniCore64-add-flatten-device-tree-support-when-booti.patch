From 1e96962bd1f8d20d20d05a385cfb115cc0102cb7 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Mon, 2 Jan 2012 14:54:32 +0800
Subject: [PATCH 186/641] UniCore64: add flatten device tree support when
 booting on fpga board

Signed-off-by: Yu Yue <yuyue@mprc.pku.edu.cn>
Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/.gitignore              |    1 +
 arch/unicore64/boot/Makefile           |    7 +++++--
 arch/unicore64/boot/boot-head.S        |   14 ++++++++++++++
 arch/unicore64/boot/unicore64-fpga.dts |    4 ++++
 4 files changed, 24 insertions(+), 2 deletions(-)
 create mode 100644 arch/unicore64/boot/unicore64-fpga.dts

diff --git a/arch/unicore64/.gitignore b/arch/unicore64/.gitignore
index dacae48..6e742c3 100644
--- a/arch/unicore64/.gitignore
+++ b/arch/unicore64/.gitignore
@@ -5,6 +5,7 @@ kernel/vmlinux.lds
 #
 # Generated files in boot
 #
+boot/*.dtb
 boot/boot.lds
 boot/Image
 boot/zImage
diff --git a/arch/unicore64/boot/Makefile b/arch/unicore64/boot/Makefile
index 3c65efe..3fc095b 100644
--- a/arch/unicore64/boot/Makefile
+++ b/arch/unicore64/boot/Makefile
@@ -1,5 +1,5 @@
 # All targets during boot
-targets		:= Image piggy.bin boot.lds boot.bin zImage
+targets		:= Image piggy.bin boot.lds boot.bin zImage unicore64-fpga.dtb
 
 # Do not recognize built-in functions in uncompress.c
 EXTRA_CFLAGS	:= -fno-builtin
@@ -20,7 +20,10 @@ suffix_$(CONFIG_KERNEL_LZMA)	:= lzma
 $(obj)/piggy.bin: $(obj)/Image FORCE
 	$(call if_changed,$(suffix_y))
 
-$(obj)/boot-head.o: $(obj)/piggy.bin
+$(obj)/%.dtb: $(obj)/%.dts FORCE
+	$(call if_changed,dtc)
+
+$(obj)/boot-head.o: $(obj)/piggy.bin $(obj)/unicore64-fpga.dtb
 
 BOOT_OBJS	:= $(srctree)/arch/unicore64/lib/memcpy.o
 BOOT_OBJS	+= $(srctree)/arch/unicore64/lib/memset.o
diff --git a/arch/unicore64/boot/boot-head.S b/arch/unicore64/boot/boot-head.S
index 7e74c42..d8282a3 100644
--- a/arch/unicore64/boot/boot-head.S
+++ b/arch/unicore64/boot/boot-head.S
@@ -34,6 +34,16 @@ _start:
 	 */
 	__head_clear_bss
 
+#ifdef CONFIG_ARCH_FPGA
+	/*
+	 * Prepare early devtree for fpga board.
+	 */
+	dmovl	r0, #UC64_PM_DTB_START
+	adr	r1, dtb_data
+	dmovl	r2, #dtb_data_end - dtb_data
+	call	memcpy
+#endif /* CONFIG_ARCH_FPGA */
+
 	/*
 	 * Call decompress_kernel, and it's three parameters are:
 	 *   r0: output_start
@@ -61,5 +71,9 @@ _start:
 	dmovl	r0, #UC64_VM_KIMAGE_START
 	jump	r0
 
+dtb_data:
+	.incbin "arch/unicore64/boot/unicore64-fpga.dtb"
+dtb_data_end:
+
 	.section .piggydata
 	.incbin "arch/unicore64/boot/piggy.bin"
diff --git a/arch/unicore64/boot/unicore64-fpga.dts b/arch/unicore64/boot/unicore64-fpga.dts
new file mode 100644
index 0000000..39b4d66
--- /dev/null
+++ b/arch/unicore64/boot/unicore64-fpga.dts
@@ -0,0 +1,4 @@
+/dts-v1/;
+/ {
+	model = "unicore64";
+};
-- 
1.7.9.5

