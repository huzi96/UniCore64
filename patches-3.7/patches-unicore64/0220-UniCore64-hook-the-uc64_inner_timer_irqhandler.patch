From 7f16866af3ef4f159c0e0f42ba524c3db3e91692 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Mon, 16 Jan 2012 13:20:30 +0800
Subject: [PATCH 220/641] UniCore64: hook the uc64_inner_timer_irqhandler

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/kernel/entry.S |    2 ++
 arch/unicore64/kernel/time.c  |   32 +++++++++-----------------------
 2 files changed, 11 insertions(+), 23 deletions(-)

diff --git a/arch/unicore64/kernel/entry.S b/arch/unicore64/kernel/entry.S
index 78cc374..50276e2 100644
--- a/arch/unicore64/kernel/entry.S
+++ b/arch/unicore64/kernel/entry.S
@@ -36,6 +36,8 @@ ENDPROC(__vectors_table)
 ENTRY(__vec_int_ost)
 	__priv_context_save
 
+	call	uc64_inner_timer_irqhandler
+
 	__priv_context_restore
 	eret
 ENDPROC(__vec_int_ost)
diff --git a/arch/unicore64/kernel/time.c b/arch/unicore64/kernel/time.c
index 4eb8ec2..79b0ce3 100644
--- a/arch/unicore64/kernel/time.c
+++ b/arch/unicore64/kernel/time.c
@@ -6,7 +6,6 @@
 #include <linux/clockchips.h>
 
 #include <arch/hwdef-copro.h>
-#include <arch/hwdef-irq.h>
 
 #define INNER_TIMER_MATCHREG		p1.c0
 #define INNER_TIMER_COUNTER		p1.c1
@@ -63,18 +62,6 @@ static void uc64_inner_timer_set_mode(enum clock_event_mode mode,
 	}
 }
 
-static irqreturn_t uc64_inner_timer_irqhandler(int irq, void *dev_id)
-{
-	struct clock_event_device *c = dev_id;
-
-	/* Disarm the compare/match, signal the event. */
-	uc64_inner_timer_irq_disable();
-	uc64_inner_timer_status_clear();
-	c->event_handler(c);
-
-	return IRQ_HANDLED;
-}
-
 static struct clock_event_device uc64_inner_timer_ce = {
 	.name		= "uc64-inner-timer-clock-event-device",
 	.features	= CLOCK_EVT_FEAT_ONESHOT,
@@ -82,13 +69,6 @@ static struct clock_event_device uc64_inner_timer_ce = {
 	.set_mode	= uc64_inner_timer_set_mode,
 };
 
-static struct irqaction uc64_inner_timer_irq = {
-	.name		= "uc64-inner-timer-irq",
-	.flags		= IRQF_TIMER | IRQF_IRQPOLL,
-	.handler	= uc64_inner_timer_irqhandler,
-	.dev_id		= &uc64_inner_timer_ce,
-};
-
 static struct clocksource uc64_inner_timer_cs = {
 	.name		= "uc64-inner-timer-clocksource",
 	.read		= uc64_inner_timer_read,
@@ -96,6 +76,15 @@ static struct clocksource uc64_inner_timer_cs = {
 	.flags		= CLOCK_SOURCE_IS_CONTINUOUS,
 };
 
+void uc64_inner_timer_irqhandler(void)
+{
+	/* Disarm the compare/match, signal the event. */
+	uc64_inner_timer_irq_disable();
+	uc64_inner_timer_status_clear();
+
+	uc64_inner_timer_ce.event_handler(&uc64_inner_timer_ce);
+}
+
 /**
  * time_init() -
  */
@@ -106,8 +95,5 @@ void __init time_init(void)
 	uc64_inner_timer_status_clear();
 
 	clockevents_calc_mult_shift(&uc64_inner_timer_ce, CLOCK_TICK_RATE, 5);
-
-	setup_irq(IRQ_TIMER0, &uc64_inner_timer_irq);
-
 	clocksource_register_hz(&uc64_inner_timer_cs, CLOCK_TICK_RATE);
 }
-- 
1.7.9.5

