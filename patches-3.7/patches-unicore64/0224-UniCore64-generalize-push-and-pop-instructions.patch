From 78e5a8935d8a2ec0e847d9c95973b8f59e507bee Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Mon, 16 Jan 2012 16:17:51 +0800
Subject: [PATCH 224/641] UniCore64: generalize push and pop instructions

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/include/arch/asm-common.h |   10 ++++++++--
 arch/unicore64/kernel/entry.S            |    4 ++--
 arch/unicore64/kernel/head.S             |    4 ++--
 3 files changed, 12 insertions(+), 6 deletions(-)

diff --git a/arch/unicore64/include/arch/asm-common.h b/arch/unicore64/include/arch/asm-common.h
index fadad48..069272b 100644
--- a/arch/unicore64/include/arch/asm-common.h
+++ b/arch/unicore64/include/arch/asm-common.h
@@ -6,8 +6,6 @@
 #ifdef __ASSEMBLY__
 #define csub		cmpsub
 #define dcsub		dcmpsub
-#define push_lr		std.w	lr, [sp-], #8
-#define pop_lr		ldd.w	lr, [sp]+, #8
 #endif /* __ASSEMBLY__ */
 
 /*
@@ -20,4 +18,12 @@
 #define __ASMMACRO_WRAP(code...)	__asm__(__stringify(code));
 #endif /* __ASSEMBLY__ */
 
+__ASMMACRO_WRAP(.macro	uc64_push, rt;
+			std.w	&rt, [sp-], #8;
+		.endm)
+
+__ASMMACRO_WRAP(.macro	uc64_pop, rt;
+			ldd.w	&rt, [sp]+, #8;
+		.endm)
+
 #endif /* __UNICORE64_ARCH_ASM_COMMON_H__ */
diff --git a/arch/unicore64/kernel/entry.S b/arch/unicore64/kernel/entry.S
index 50276e2..754d0fb 100644
--- a/arch/unicore64/kernel/entry.S
+++ b/arch/unicore64/kernel/entry.S
@@ -3,12 +3,12 @@
 
 	.macro	__priv_context_save
 	/* save all registers */
-	push_lr
+	uc64_push	lr
 	.endm
 
 	.macro __priv_context_restore
 	/* restore all registers */
-	pop_lr
+	uc64_pop	lr
 	.endm
 
 /**
diff --git a/arch/unicore64/kernel/head.S b/arch/unicore64/kernel/head.S
index 092588c..5963ba0 100644
--- a/arch/unicore64/kernel/head.S
+++ b/arch/unicore64/kernel/head.S
@@ -65,7 +65,7 @@ __priv_sp:
  * it will map the first 64MB of kernel image
  */
 ENTRY(__head_pgtable_init)
-	push_lr
+	uc64_push	lr
 	/*
 	 * Step one: clear 4k level-one page table for pgd
 	 */
@@ -119,6 +119,6 @@ ENTRY(__head_pgtable_init)
 	dmovl	r0, #UC64_PM_PGTABLE_PGD
 	uc64_set_pgd	r0
 
-	pop_lr
+	uc64_pop	lr
 	return
 ENDPROC(__head_pgtable_init)
-- 
1.7.9.5

