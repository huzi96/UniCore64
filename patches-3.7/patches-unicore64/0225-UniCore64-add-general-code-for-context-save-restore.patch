From 8ccc85111d0bf46526198a69257ad440741b9f28 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Mon, 16 Jan 2012 16:37:59 +0800
Subject: [PATCH 225/641] UniCore64: add general code for context save/restore

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/kernel/entry.S |   24 +++++++++++++++++++++---
 1 file changed, 21 insertions(+), 3 deletions(-)

diff --git a/arch/unicore64/kernel/entry.S b/arch/unicore64/kernel/entry.S
index 754d0fb..75f9456c 100644
--- a/arch/unicore64/kernel/entry.S
+++ b/arch/unicore64/kernel/entry.S
@@ -2,13 +2,31 @@
 #include <arch/asm-common.h>
 
 	.macro	__priv_context_save
-	/* save all registers */
-	uc64_push	lr
+	/* save all gp registers */
+	.irp	n, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, \
+		16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 30
+	uc64_push	r\n
+	.endr
+
+	/* save bsr and bfr */
+	mov	bsr, r0
+	uc64_push	r0
+	mov	bfr, r0
+	uc64_push	r0
 	.endm
 
 	.macro __priv_context_restore
+	/* restore bfr and bsr registers */
+	uc64_pop	r0
+	mov	bfr, r0
+	uc64_pop	r0
+	mov	bsr, r0
+
 	/* restore all registers */
-	uc64_pop	lr
+	.irp	n, 30, 28, 27, 26, 25, 24, 23, 22, 21, 20, 19, 18, 17, 16, \
+		15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0
+	uc64_pop	r\n
+	.endr
 	.endm
 
 /**
-- 
1.7.9.5

