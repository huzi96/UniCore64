From c3d047bd96bae3792fbce116fe20acad73d86357 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Tue, 17 Jan 2012 23:02:11 +0800
Subject: [PATCH 236/641] UniCore64: add CONFIG_ARCH_PUV3 and puv3-core.c

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/Kconfig                   |    4 +++
 arch/unicore64/include/arch/hwdef-puv3.h |    2 ++
 arch/unicore64/kernel/Makefile           |    1 +
 arch/unicore64/kernel/puv3-core.c        |   49 ++++++++++++++++++++++++++++++
 4 files changed, 56 insertions(+)
 create mode 100644 arch/unicore64/kernel/puv3-core.c

diff --git a/arch/unicore64/Kconfig b/arch/unicore64/Kconfig
index b5c243e..a836d15e 100644
--- a/arch/unicore64/Kconfig
+++ b/arch/unicore64/Kconfig
@@ -55,6 +55,10 @@ config ARCH_FPGA
 	  ONLY enabled this option when debugging and running in FPGA board.
 
 	  If unsure, say N.
+
+config ARCH_PUV3
+	def_bool y
+
 endmenu
 
 menu "Kernel Features"
diff --git a/arch/unicore64/include/arch/hwdef-puv3.h b/arch/unicore64/include/arch/hwdef-puv3.h
index 2ce60b8..7597379 100644
--- a/arch/unicore64/include/arch/hwdef-puv3.h
+++ b/arch/unicore64/include/arch/hwdef-puv3.h
@@ -3,6 +3,8 @@
 
 #include <arch/hwdef-memory.h>
 
+#define PUV3_IOMEM_REGION	__BS(12, 0)
+
 /*
  * PUV3 System Bus Addresses (PCI): 0x80000000 - 0xBFFFFFFF (1GB)
  * 0x80000000 - 0x8000000B 12B    PCI Configuration regs
diff --git a/arch/unicore64/kernel/Makefile b/arch/unicore64/kernel/Makefile
index cf0a4ad..98d9251 100644
--- a/arch/unicore64/kernel/Makefile
+++ b/arch/unicore64/kernel/Makefile
@@ -10,5 +10,6 @@ obj-y			+= time.o traps.o
 obj-$(CONFIG_UNICORE64)		+= cpu-uc64.o
 obj-$(CONFIG_OF_EARLY_FLATTREE)	+= devtree.o
 obj-$(CONFIG_EARLY_PRINTK)	+= early_printk.o
+obj-$(CONFIG_ARCH_PUV3)		+= puv3-core.o
 
 extra-y			:= vmlinux.lds
diff --git a/arch/unicore64/kernel/puv3-core.c b/arch/unicore64/kernel/puv3-core.c
new file mode 100644
index 0000000..9b18971
--- /dev/null
+++ b/arch/unicore64/kernel/puv3-core.c
@@ -0,0 +1,49 @@
+#include <linux/init.h>
+#include <linux/platform_device.h>
+
+#include <arch/hwdef-puv3.h>
+#include <arch/hwdef-irq.h>
+
+static struct resource puv3_gpio_resources[] = {
+	[0] = {
+		.start	= PUV3_GPIO_BASE,
+		.end	= PUV3_GPIO_BASE + PUV3_IOMEM_REGION,
+		.flags	= IORESOURCE_MEM,
+	},
+};
+
+static struct resource puv3_intc_resources[] = {
+	[0] = {
+		.start	= PUV3_INTC_BASE,
+		.end	= PUV3_INTC_BASE + PUV3_IOMEM_REGION,
+		.flags	= IORESOURCE_MEM,
+	},
+};
+
+static struct resource puv3_ost_resources[] = {
+	[0] = {
+		.start	= PUV3_OST_BASE,
+		.end	= PUV3_OST_BASE + PUV3_IOMEM_REGION,
+		.flags	= IORESOURCE_MEM,
+	},
+	[1] = {
+		.start	= IRQ_TIMER0,
+		.flags	= IORESOURCE_IRQ,
+	},
+};
+
+int __init puv3_core_init(void)
+{
+	/* APB-5 */
+	platform_device_register_simple("PUV3-INTC", -1,
+			puv3_intc_resources, ARRAY_SIZE(puv3_intc_resources));
+	/* APB-6 */
+	platform_device_register_simple("PUV3-GPIO", -1,
+			puv3_gpio_resources, ARRAY_SIZE(puv3_gpio_resources));
+	/* APB-8 */
+	platform_device_register_simple("PUV3-OST", -1,
+			puv3_ost_resources, ARRAY_SIZE(puv3_ost_resources));
+
+	return 0;
+}
+postcore_initcall(puv3_core_init);
-- 
1.7.9.5

