From eaa055dffdc4f0439f9c2f282dac7eea6a9b34c1 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Thu, 19 Jan 2012 15:04:29 +0800
Subject: [PATCH 264/641] UniCore64: add puv3_intc_handler

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/kernel/entry.S     |   11 ++++++++++-
 arch/unicore64/kernel/puv3-intc.c |   20 ++++++++++++++++++++
 2 files changed, 30 insertions(+), 1 deletion(-)

diff --git a/arch/unicore64/kernel/entry.S b/arch/unicore64/kernel/entry.S
index 5902ad4..59f6084 100644
--- a/arch/unicore64/kernel/entry.S
+++ b/arch/unicore64/kernel/entry.S
@@ -49,7 +49,7 @@ ENTRY(__vectors_table)
 	call	__vec_invalid	/* 0x18: INT_KERNEL */
 	call	__vec_invalid	/* 0x1c: INT_FAULT */
 	call	__vec_invalid	/* 0x20: INT_TIMER */
-	call	__vec_invalid	/* 0x24: INT_PE */
+	call	__vec_int_puv3	/* 0x24: INT_PE */
 	b	__vec_int_ost	/* 0x28: INT_OST */
 	call	__vec_invalid	/* 0x2c: INT_PM */
 ENDPROC(__vectors_table)
@@ -61,6 +61,15 @@ ENTRY(__vec_invalid)
 	halt		/* no return */
 ENDPROC(__vec_invalid)
 
+ENTRY(__vec_int_puv3)
+	__priv_context_save
+
+	call	puv3_intc_handler
+
+	__priv_context_restore
+	eret
+ENDPROC(__vec_int_puv3)
+
 ENTRY(__vec_int_ost)
 	__priv_context_save
 
diff --git a/arch/unicore64/kernel/puv3-intc.c b/arch/unicore64/kernel/puv3-intc.c
index 539fbe4..c083444 100644
--- a/arch/unicore64/kernel/puv3-intc.c
+++ b/arch/unicore64/kernel/puv3-intc.c
@@ -1,4 +1,5 @@
 #include <linux/errno.h>
+#include <linux/hardirq.h>
 #include <linux/init.h>
 #include <linux/io.h>
 #include <linux/ioport.h>
@@ -81,3 +82,22 @@ static int __init puv3_intc_init(void)
 	return ret;
 }
 arch_initcall(puv3_intc_init);
+
+/*
+ * This function handles all puv3 hardware interrupts.
+ */
+void puv3_intc_handler(void)
+{
+	unsigned int irqs, irq;
+
+	for (;;) {
+		irqs = readl(INTC_ICIP) & readl(INTC_ICMR);
+		if (irqs == 0)
+			return;
+
+		irq = ffs(irqs);
+		irq_enter();
+		generic_handle_irq(irq);
+		irq_exit();
+	}
+}
-- 
1.7.9.5

