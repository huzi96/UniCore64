From 4bf71522e4b32b70be92be021f49f9d2049b1667 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Mon, 30 Jan 2012 09:30:22 +0800
Subject: [PATCH 275/641] UniCore64: add __read_uc64 and __write_uc64, and
 adjust panic handler

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/include/arch/hwdef-cpu.h |   15 +++++++++++++++
 arch/unicore64/include/asm/setup_arch.h |    1 +
 arch/unicore64/kernel/cpu-uc64.c        |    8 ++++++++
 arch/unicore64/kernel/setup.c           |    4 ++--
 4 files changed, 26 insertions(+), 2 deletions(-)

diff --git a/arch/unicore64/include/arch/hwdef-cpu.h b/arch/unicore64/include/arch/hwdef-cpu.h
index 0fd298c..4fbfe14 100644
--- a/arch/unicore64/include/arch/hwdef-cpu.h
+++ b/arch/unicore64/include/arch/hwdef-cpu.h
@@ -68,4 +68,19 @@
 #define AFR_Z_BIT		__BF(1, 1, 2)
 #define AFR_S_BIT		__BF(1, 1, 3)
 
+/* To read asr, afr, bsr, and bsr */
+#define __read_uc64(reg)					\
+	({							\
+		unsigned long __val;				\
+		__asm__("dmov	%0, " __stringify(reg)		\
+		    : "=r" (__val));				\
+		__val;						\
+	})
+
+#define __write_uc64(reg_value, reg)				\
+	({							\
+		__asm__("dmov	" __stringify(reg) ", %0"	\
+		    : : "r" (reg_value));			\
+	})
+
 #endif /* __UNICORE64_ARCH_HWDEF_CPU_H__ */
diff --git a/arch/unicore64/include/asm/setup_arch.h b/arch/unicore64/include/asm/setup_arch.h
index 43e030c..2d90664 100644
--- a/arch/unicore64/include/asm/setup_arch.h
+++ b/arch/unicore64/include/asm/setup_arch.h
@@ -14,4 +14,5 @@ extern void setup_arch_devtree(char *cmdline);
 
 extern char __vectors_table[];
 
+extern void show_uc64_info(void);
 #endif /* __UNICORE64_ASM_SETUP_ARCH_H__ */
diff --git a/arch/unicore64/kernel/cpu-uc64.c b/arch/unicore64/kernel/cpu-uc64.c
index 78f222d..01754b6 100644
--- a/arch/unicore64/kernel/cpu-uc64.c
+++ b/arch/unicore64/kernel/cpu-uc64.c
@@ -3,6 +3,7 @@
 
 #include <asm/setup_arch.h>
 
+#include <arch/hwdef-cpu.h>
 #include <arch/hwdef-cp0-sysctrl.h>
 
 /**
@@ -196,3 +197,10 @@ void __init setup_arch_cpuinfo(void)
 #undef CACHETYPE_SIZE
 #undef CACHETYPE_ASSOC
 #undef CACHETYPE_LINE
+
+void show_uc64_info(void)
+{
+	pr_emerg("\nUniCore64 Information:\n");
+	pr_emerg(" ASR BSR: %16lx %16lx\n", __read_uc64(asr), __read_uc64(bsr));
+	pr_emerg(" AFR BFR: %16lx %16lx\n", __read_uc64(afr), __read_uc64(bfr));
+}
diff --git a/arch/unicore64/kernel/setup.c b/arch/unicore64/kernel/setup.c
index fdb1e5d..6c0ccf3 100644
--- a/arch/unicore64/kernel/setup.c
+++ b/arch/unicore64/kernel/setup.c
@@ -11,8 +11,8 @@ static char __initdata builtin_cmdline[COMMAND_LINE_SIZE] = CONFIG_CMDLINE;
 static int uc64_panic_event(struct notifier_block *this,
 		unsigned long event, void *ptr)
 {
-	/* FIXME */
-	pr_emerg("Kernel OOPS in %s", __func__);
+	show_uc64_info();
+
 	return NOTIFY_DONE;
 }
 
-- 
1.7.9.5

