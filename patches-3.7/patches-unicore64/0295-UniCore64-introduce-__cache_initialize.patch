From 448b4fe5cf8df55d42f6df2b4110f62a7d390dfb Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Fri, 3 Feb 2012 09:09:52 +0800
Subject: [PATCH 295/641] UniCore64: introduce __cache_initialize

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/boot/boot.S                |   11 ++---------
 arch/unicore64/include/arch/head-macros.S |    7 +++++--
 arch/unicore64/kernel/head.S              |   10 ++++------
 3 files changed, 11 insertions(+), 17 deletions(-)

diff --git a/arch/unicore64/boot/boot.S b/arch/unicore64/boot/boot.S
index c7e300c..ab870b2 100644
--- a/arch/unicore64/boot/boot.S
+++ b/arch/unicore64/boot/boot.S
@@ -13,16 +13,9 @@ _start:
 	__head_initialize	r0
 
 	/*
-	 * Initialise TLB and Caches.
+	 * Initialize dcache and icache.
 	 */
-	__invalid_dcache	r0
-	__invalid_icache	r0
-	__invalid_tlb		r0
-
-	/*
-	 * Turn on dcache and icache.
-	 */
-	uc64_enable_cache	r0
+	__cache_initialize	r0
 
 	/*
 	 * Set the sp register.
diff --git a/arch/unicore64/include/arch/head-macros.S b/arch/unicore64/include/arch/head-macros.S
index d491d0f..79879aa 100644
--- a/arch/unicore64/include/arch/head-macros.S
+++ b/arch/unicore64/include/arch/head-macros.S
@@ -41,9 +41,12 @@
 .endm
 
 /*
- * uc64_enable_cache - enable entire icache and dcache
+ * __cache_initialize - invalid and enable icache and dcache
  */
-.macro	uc64_enable_cache, rt
+.macro	__cache_initialize, rt
+	__invalid_dcache	&rt
+	__invalid_icache	&rt
+
 	movc	&rt, p0.c1, #0;
 #ifndef CONFIG_CPU_DCACHE_DISABLE
 	dor	&rt, &rt, #4;
diff --git a/arch/unicore64/kernel/head.S b/arch/unicore64/kernel/head.S
index 5d11be0..f8aab3f 100644
--- a/arch/unicore64/kernel/head.S
+++ b/arch/unicore64/kernel/head.S
@@ -31,21 +31,19 @@
 ENTRY(stext)
 	__head_initialize	r0
 
+	__cache_initialize	r0
+
 	/* Set sp for function discipline */
 	ldd	sp, __priv_sp
 
 	call	__head_pgtable_init
 
-	__invalid_tlb		r0
-	__invalid_dcache	r0
-	__invalid_icache	r0
-
-	uc64_enable_cache	r0
-
 	/*
 	 * Enable the MMU.  This completely changes the structure of the visible
 	 * memory space.  You will not be able to trace execution through this.
 	 */
+	__invalid_tlb		r0
+
 	movc	r0, CP0_CTRLREG, #0
 	dor	r0, r0, #CP0_CTRLREG_MMU
 	movc	CP0_CTRLREG, r0, #0
-- 
1.7.9.5

