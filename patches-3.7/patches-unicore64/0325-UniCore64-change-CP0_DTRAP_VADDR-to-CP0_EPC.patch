From 1b19eb98ed45066328b47d73cc1ef8109382a884 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Wed, 14 Mar 2012 10:52:48 +0800
Subject: [PATCH 325/641] UniCore64: change CP0_DTRAP_VADDR to CP0_EPC

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/include/arch/hwdef-cp0-sysctrl.h |    4 ++--
 arch/unicore64/kernel/cpu-uc64.c                |    3 ++-
 arch/unicore64/kernel/entry.S                   |    4 ++--
 3 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/arch/unicore64/include/arch/hwdef-cp0-sysctrl.h b/arch/unicore64/include/arch/hwdef-cp0-sysctrl.h
index 5f013f6..78747a0 100644
--- a/arch/unicore64/include/arch/hwdef-cp0-sysctrl.h
+++ b/arch/unicore64/include/arch/hwdef-cp0-sysctrl.h
@@ -17,7 +17,7 @@
  * CP0 CR1:	control reg. of mmu and Cache
  * CP0 CR2:	reg. for Translation Table Base and Address Space Identifier
  * CP0 CR3:	reg. for status information of instruction and data abort
- * CP0 CR4:	reg. for virtual address of data abort
+ * CP0 CR4:	reg. for return address of exceptions
  * CP0 CR5:	reg. for TLB management
  * CP0 CR6:	reg. for DCache management
  * CP0 CR7:	reg. for ICache management
@@ -32,7 +32,7 @@
 #define CP0_CTRLREG		p0.c1
 #define CP0_TTB_ASID		p0.c2
 #define CP0_TRAP_STAT		p0.c3
-#define CP0_DTRAP_VADDR		p0.c4
+#define CP0_EPC			p0.c4
 #define CP0_TLB			p0.c5
 #define CP0_DCACHE		p0.c6
 #define CP0_ICACHE		p0.c7
diff --git a/arch/unicore64/kernel/cpu-uc64.c b/arch/unicore64/kernel/cpu-uc64.c
index fea9857..70039e2 100644
--- a/arch/unicore64/kernel/cpu-uc64.c
+++ b/arch/unicore64/kernel/cpu-uc64.c
@@ -214,7 +214,8 @@ void __show_cp0_regs(void)
 	pr_emerg(" TTB/ASID: %16lx\n", __read_cp(CP0_TTB_ASID));
 	pr_emerg(" ITRAP_STAT: %16lx", __read_cp_op(CP0_TRAP_STAT, 0));
 	pr_emerg(" DTRAP_STAT: %16lx", __read_cp_op(CP0_TRAP_STAT, 1));
-	pr_emerg(" DTRAP_VADDR: %16lx\n", __read_cp(CP0_DTRAP_VADDR));
+	pr_emerg(" DTRAP_ADDR: %16lx\n", __read_cp_op(CP0_EPC, 0));
+	pr_emerg(" EXCP_ADDR: %16lx\n", __read_cp_op(CP0_EPC, 1));
 
 	pr_emerg(" MRAR_BASE: %16lx %16lx %16lx %16lx\n",
 			__read_cp_op(CP0_MRAR, 0),
diff --git a/arch/unicore64/kernel/entry.S b/arch/unicore64/kernel/entry.S
index 6d2b0f6..dbf074f 100644
--- a/arch/unicore64/kernel/entry.S
+++ b/arch/unicore64/kernel/entry.S
@@ -15,7 +15,7 @@
 	__push	r0				/* bfr */
 	dmov	r0, bsr
 	__push	r0				/* bsr */
-	movc	r0, CP0_DTRAP_VADDR, #1
+	movc	r0, CP0_EPC, #1
 	__push	r0				/* pc */
 	__push	lr				/* lr */
 	movc	r0, p0.c12, #1
@@ -37,7 +37,7 @@
 	__pop	lr				/* lr */
 	movc	p0.c12, lr, #0			/* save lr for temp use */
 	__pop	lr				/* pc */
-	movc	CP0_DTRAP_VADDR, lr, #1
+	movc	CP0_EPC, lr, #1
 	__pop	lr				/* bsr */
 	mov	bsr, lr
 	__pop	lr				/* bfr */
-- 
1.7.9.5

