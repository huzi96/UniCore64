From 77a8611b96eadc81480e2b8e38366bc6993f3830 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Sun, 1 Apr 2012 16:32:51 +0800
Subject: [PATCH 336/641] UniCore64: add copy_thread implementation (not
 complete)

Signed-off-by: Liang Rongrong <liangrongrong@mprc.pku.edu.cn>
Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/include/asm/processor.h |    4 +++-
 arch/unicore64/kernel/entry.S          |    8 ++++++++
 arch/unicore64/kernel/process.c        |   13 +++++++++++--
 3 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/arch/unicore64/include/asm/processor.h b/arch/unicore64/include/asm/processor.h
index b421ff6..e43ac93 100644
--- a/arch/unicore64/include/asm/processor.h
+++ b/arch/unicore64/include/asm/processor.h
@@ -16,7 +16,9 @@
 #define current_text_addr()	({ __label__ _l; _l: &&_l; })
 
 struct thread_struct {
-	unsigned long pc;
+	unsigned long pc;	/* instruction pointer */
+	unsigned long ksp;	/* kernel stack pointer */
+	unsigned long usp;	/* user stack pointer */
 };
 
 #define INIT_THREAD		{ }
diff --git a/arch/unicore64/kernel/entry.S b/arch/unicore64/kernel/entry.S
index cd6970c..2edc731 100644
--- a/arch/unicore64/kernel/entry.S
+++ b/arch/unicore64/kernel/entry.S
@@ -65,6 +65,14 @@
 	.endm
 
 /**
+ * ret_from_fork - This is how we return from a fork.
+ */
+ENTRY(ret_from_fork)
+	call	schedule_tail
+	/* TODO */
+ENDPROC(ret_from_fork)
+
+/**
  * __switch_to - Register switch for UniCore3 processors
  */
 ENTRY(__switch_to)
diff --git a/arch/unicore64/kernel/process.c b/arch/unicore64/kernel/process.c
index 3d5c6c2..1e18e02 100644
--- a/arch/unicore64/kernel/process.c
+++ b/arch/unicore64/kernel/process.c
@@ -33,6 +33,8 @@ int kernel_thread(int (*fn)(void *), void *arg, unsigned long flags)
 			0, &regs, 0, NULL, NULL);
 }
 
+asmlinkage void ret_from_fork(void) __asm__("ret_from_fork");
+
 /**
  * copy_thread() - Copy a thread
  * @clone_flags:
@@ -44,8 +46,15 @@ int kernel_thread(int (*fn)(void *), void *arg, unsigned long flags)
 int copy_thread(unsigned long clone_flags, unsigned long stack_start,
 	    unsigned long stk_sz, struct task_struct *p, struct pt_regs *regs)
 {
-	/* FIXME */
-	BUG();
+	struct pt_regs *childregs = task_pt_regs(p);
+
+	*childregs = *regs;
+	childregs->UC64_R00 = 0;
+
+	p->thread.usp = stack_start;
+	p->thread.ksp = (unsigned long)childregs;
+	p->thread.pc = (unsigned long)ret_from_fork;
+
 	return 0;
 }
 
-- 
1.7.9.5

