From 7186bc529a9fea5f2c1e829a0c3783e070aa721e Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Mon, 21 May 2012 12:35:40 +0800
Subject: [PATCH 350/641] UniCore64: implement __switch_to

Signed-off-by: Liang Rongrong <liangrongrong@mprc.pku.edu.cn>
Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/kernel/Makefile      |    2 +-
 arch/unicore64/kernel/asm-offsets.c |    7 +++++++
 arch/unicore64/kernel/entry.S       |    7 -------
 arch/unicore64/kernel/switch_to.S   |   36 +++++++++++++++++++++++++++++++++++
 4 files changed, 44 insertions(+), 8 deletions(-)
 create mode 100644 arch/unicore64/kernel/switch_to.S

diff --git a/arch/unicore64/kernel/Makefile b/arch/unicore64/kernel/Makefile
index 3571281..211b87a 100644
--- a/arch/unicore64/kernel/Makefile
+++ b/arch/unicore64/kernel/Makefile
@@ -1,7 +1,7 @@
 #
 # Makefile for the arch/unicore64/kernel.
 #
-obj-y			:= head.o entry.o
+obj-y			:= head.o entry.o switch_to.o
 obj-y			+= init_task.o irq.o
 obj-y			+= process.o ptrace.o
 obj-y			+= setup.o sys.o
diff --git a/arch/unicore64/kernel/asm-offsets.c b/arch/unicore64/kernel/asm-offsets.c
index 5fd9618..ef5c659 100644
--- a/arch/unicore64/kernel/asm-offsets.c
+++ b/arch/unicore64/kernel/asm-offsets.c
@@ -11,10 +11,17 @@
  * it under the terms of the GNU General Public License version 2 as
  * published by the Free Software Foundation.
  */
+#include <linux/sched.h>
 #include <linux/kbuild.h>
 
 int main(void)
 {
+	OFFSET(TASK_THREAD,		task_struct, thread);
 	BLANK();
+
+	OFFSET(THREAD_PC,		thread_struct, pc);
+	OFFSET(THREAD_KSP,		thread_struct, ksp);
+	BLANK();
+
 	return 0;
 }
diff --git a/arch/unicore64/kernel/entry.S b/arch/unicore64/kernel/entry.S
index 7264de4..5253ef0 100644
--- a/arch/unicore64/kernel/entry.S
+++ b/arch/unicore64/kernel/entry.S
@@ -70,13 +70,6 @@ ENTRY(ret_from_fork)
 	/* TODO */
 ENDPROC(ret_from_fork)
 
-/**
- * __switch_to - Register switch for UniCore3 processors
- */
-ENTRY(__switch_to)
-	/* FIXME: */
-ENDPROC(__switch_to)
-
 ENTRY(__vec_invalid)
 	dmovl		r0, 0xdeaddeaddeaddead
 	__putdata	r0
diff --git a/arch/unicore64/kernel/switch_to.S b/arch/unicore64/kernel/switch_to.S
new file mode 100644
index 0000000..f46b66d
--- /dev/null
+++ b/arch/unicore64/kernel/switch_to.S
@@ -0,0 +1,36 @@
+#include <linux/linkage.h>
+#include <arch/asm-common.h>
+#include <generated/asm-offsets.h>
+
+/**
+ * __switch_to - Register switch for UniCore3 processors
+ * @prev:	previous task_struct in r0
+ * @next:	next task_struct in r1
+ */
+ENTRY(__switch_to)
+	@ Save all callee-saved registers, from r16 to r27
+	.irp	n, 27, 26, 25, 24, 23, 22, 21, 20, 19, 18, 17, 16
+	__push	r\n
+	.endr
+
+	@ Save stack pointer and return address
+	dadd	ip, r0, #TASK_THREAD + THREAD_PC
+	std	lr, [ip]
+	dadd	ip, r0, #TASK_THREAD + THREAD_KSP
+	std	sp, [ip]
+
+	@ Now, switch to another thread
+
+	@ Restore stack pointer and return address
+	dadd	ip, r1, #TASK_THREAD + THREAD_PC
+	ldd	lr, [ip]
+	dadd	ip, r1, #TASK_THREAD + THREAD_KSP
+	ldd	sp, [ip]
+
+	@ Restore all callee-saved registers, from r16 to r27
+	.irp	n, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27
+	__pop	r\n
+	.endr
+
+	return
+ENDPROC(__switch_to)
-- 
1.7.9.5

