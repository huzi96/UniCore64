From 074694513111c2be94d274b90a38b935f913e62c Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Wed, 13 Jun 2012 16:48:47 +0800
Subject: [PATCH 378/641] UniCore64: adjust dma_map_ops definitions for new
 version

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/include/asm/dma-mapping.h |    4 ++--
 arch/unicore64/mm/dma-swiotlb.c          |   18 ++++++++++++++++--
 2 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/arch/unicore64/include/asm/dma-mapping.h b/arch/unicore64/include/asm/dma-mapping.h
index d583608..fb9cad7 100644
--- a/arch/unicore64/include/asm/dma-mapping.h
+++ b/arch/unicore64/include/asm/dma-mapping.h
@@ -8,9 +8,9 @@ extern struct dma_map_ops swiotlb_dma_map_ops;
 #define dma_supported(d, m)			\
 		(get_dma_ops(dev)->dma_supported((d), (m)))
 #define dma_alloc_coherent(d, s, h, f)		\
-		(get_dma_ops(dev)->alloc_coherent((d), (s), (h), (f)))
+		(get_dma_ops(dev)->alloc((d), (s), (h), (f), NULL))
 #define dma_free_coherent(d, s, a, h)		\
-		(get_dma_ops(dev)->free_coherent((d), (s), (a), (h)))
+		(get_dma_ops(dev)->free((d), (s), (a), (h), NULL))
 
 #define dma_alloc_noncoherent(d, s, h, f)	\
 		dma_alloc_coherent((d), (s), (h), (f))
diff --git a/arch/unicore64/mm/dma-swiotlb.c b/arch/unicore64/mm/dma-swiotlb.c
index 11321cb..68f79c0 100644
--- a/arch/unicore64/mm/dma-swiotlb.c
+++ b/arch/unicore64/mm/dma-swiotlb.c
@@ -52,9 +52,23 @@ void dma_mark_clean(void *addr, size_t size)
 	BUG();
 }
 
+static void *__uc64_swiotlb_alloc_coherent(struct device *dev, size_t size,
+				        dma_addr_t *dma_handle, gfp_t flags,
+					struct dma_attrs *attrs)
+{
+	return swiotlb_alloc_coherent(dev, size, dma_handle, flags);
+}
+
+static void __uc64_swiotlb_free_coherent(struct device *dev, size_t size,
+					void *vaddr, dma_addr_t dma_addr,
+					struct dma_attrs *attrs)
+{
+	swiotlb_free_coherent(dev, size, vaddr, dma_addr);
+}
+
 struct dma_map_ops swiotlb_dma_map_ops = {
-	.alloc_coherent = swiotlb_alloc_coherent,
-	.free_coherent = swiotlb_free_coherent,
+	.alloc = __uc64_swiotlb_alloc_coherent,
+	.free = __uc64_swiotlb_free_coherent,
 	.map_sg = swiotlb_map_sg_attrs,
 	.unmap_sg = swiotlb_unmap_sg_attrs,
 	.dma_supported = swiotlb_dma_supported,
-- 
1.7.9.5

