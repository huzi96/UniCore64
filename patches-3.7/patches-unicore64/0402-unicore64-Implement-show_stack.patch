From 9fc10a39ac0240bec662bf7891f9aa8a55c180a5 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Sat, 25 Aug 2012 15:43:16 +0800
Subject: [PATCH 402/641] unicore64: Implement show_stack

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/kernel/setup.c    |    3 +++
 arch/unicore64/kernel/showinfo.c |   19 ++++++++++++-------
 2 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/arch/unicore64/kernel/setup.c b/arch/unicore64/kernel/setup.c
index 3beb380..13ca6b0 100644
--- a/arch/unicore64/kernel/setup.c
+++ b/arch/unicore64/kernel/setup.c
@@ -14,7 +14,10 @@ static char __initdata builtin_cmdline[COMMAND_LINE_SIZE] = CONFIG_CMDLINE;
 static int uc64_panic_event(struct notifier_block *this,
 		unsigned long event, void *ptr)
 {
+	register unsigned long *sp __asm__("sp");
+
 	show_regs(NULL);
+	show_stack(current, sp);
 
 	return NOTIFY_DONE;
 }
diff --git a/arch/unicore64/kernel/showinfo.c b/arch/unicore64/kernel/showinfo.c
index 26d9534..f035d4a 100644
--- a/arch/unicore64/kernel/showinfo.c
+++ b/arch/unicore64/kernel/showinfo.c
@@ -233,13 +233,8 @@ int dump_fpu(struct pt_regs *regs, elf_fpregset_t *fp)
  */
 void show_regs(struct pt_regs *regs)
 {
-	unsigned long stack_end;
-
 	__show_uc64_regs(regs);
 	__show_cp0_regs();
-
-	stack_end = (unsigned long)current_thread_info();
-	__dump_mem(stack_end, stack_end + THREAD_SIZE);
 }
 
 /**
@@ -249,6 +244,16 @@ void show_regs(struct pt_regs *regs)
  */
 void show_stack(struct task_struct *tsk, unsigned long *sp)
 {
-	/* FIXME */
-	BUG();
+	unsigned long addr;
+	unsigned long stack_end;
+
+	pr_info("\nCall Trace:\n");
+	while (!kstack_end(sp)) {
+		addr = *sp++;
+		if (__kernel_text_address(addr))
+			pr_info(" [<%016lx>] %pS\n", addr, (void *)addr);
+	}
+
+	stack_end = (unsigned long)current_thread_info();
+	__dump_mem(stack_end, stack_end + THREAD_SIZE);
 }
-- 
1.7.9.5

