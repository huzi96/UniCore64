From 5d54a1e2b8daee60be36aa4e7f4a419874175bb5 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Wed, 29 Aug 2012 08:37:43 +0800
Subject: [PATCH 407/641] unicore64: Adjust mcount implementation and enable
 it as default

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/Kconfig.debug               |    7 +++++++
 arch/unicore64/configs/unicore64_defconfig |    1 +
 arch/unicore64/kernel/Makefile             |    6 ++++++
 arch/unicore64/lib/mcount.S                |   21 ++++++++++++++++-----
 arch/unicore64/mm/Makefile                 |    2 ++
 5 files changed, 32 insertions(+), 5 deletions(-)

diff --git a/arch/unicore64/Kconfig.debug b/arch/unicore64/Kconfig.debug
index e98629b..87c4a44 100644
--- a/arch/unicore64/Kconfig.debug
+++ b/arch/unicore64/Kconfig.debug
@@ -9,6 +9,13 @@ config DEBUG_OCD
 	  Say Y here if you want the debug print routines to direct their
 	  output to the UniCore On-Chip-Debugger channel.
 
+config DEBUG_MCOUNT
+	bool "Print out useful debug information for each function by mcount"
+	depends on DEBUG_OCD
+	help
+	  Say Y here if you want the debug information for each functions
+	  under arch/unicore64/kernel and arch/unicore64/mm dirs.
+
 config EARLY_PRINTK
 	def_bool DEBUG_OCD
 	help
diff --git a/arch/unicore64/configs/unicore64_defconfig b/arch/unicore64/configs/unicore64_defconfig
index faa4cdd..ba491b2 100644
--- a/arch/unicore64/configs/unicore64_defconfig
+++ b/arch/unicore64/configs/unicore64_defconfig
@@ -19,6 +19,7 @@ CONFIG_VGA_CONSOLE=n
 ### Kernel hacking
 CONFIG_DEBUG_KERNEL=y
 CONFIG_DEBUG_OCD=y
+CONFIG_DEBUG_MCOUNT=y
 
 ### Boot options
 CONFIG_CMDLINE="earlyprintk=ocd ignore_loglevel root=/dev/ram0 rw"
diff --git a/arch/unicore64/kernel/Makefile b/arch/unicore64/kernel/Makefile
index 533face..83321e3 100644
--- a/arch/unicore64/kernel/Makefile
+++ b/arch/unicore64/kernel/Makefile
@@ -1,6 +1,12 @@
 #
 # Makefile for the arch/unicore64/kernel.
 #
+
+# Handling MCOUNT situation
+ccflags-$(CONFIG_DEBUG_MCOUNT)	:= -pg
+CFLAGS_REMOVE_early_printk.o	:= -pg
+CFLAGS_REMOVE_time.o		:= -pg
+
 obj-y			:= head.o entry.o switch_to.o
 obj-y			+= irq.o
 obj-y			+= process.o ptrace.o
diff --git a/arch/unicore64/lib/mcount.S b/arch/unicore64/lib/mcount.S
index 80155f1..055e0a4 100644
--- a/arch/unicore64/lib/mcount.S
+++ b/arch/unicore64/lib/mcount.S
@@ -3,10 +3,21 @@
 #include <arch/asm-debug.h>
 
 ENTRY(mcount)
-	__push		r0
-	ldd		r0, [ip-], #8
-	dsub		r0, r0, #4
-	__putdata	r0
-	__pop		r0
+	@ Save lr and all parameter registers, from r0 to r3
+	.irp		n, 30, 3, 2, 1, 0
+	__push		r\n
+	.endr
+
+	adr		r0, mcount_info
+	dmov		r1, lr
+	dmov		r2, lr
+	call		printk
+
+	@ Restore lr and all parameter registers, from r0 to r3
+	.irp		n, 0, 1, 2, 3, 30
+	__pop		r\n
+	.endr
 	return
+
+mcount_info:		.asciz	"\t[<%016lx>] %pS\n"
 ENDPROC(mcount)
diff --git a/arch/unicore64/mm/Makefile b/arch/unicore64/mm/Makefile
index 02e5c12..e3c7e6d 100644
--- a/arch/unicore64/mm/Makefile
+++ b/arch/unicore64/mm/Makefile
@@ -1,3 +1,5 @@
+ccflags-$(CONFIG_DEBUG_MCOUNT)	:= -pg
+
 obj-y				:= fault.o ioremap.o init.o
 obj-y				+= mmu.o pgtable.o tlb.o
 obj-$(CONFIG_SWIOTLB)		+= dma-swiotlb.o
-- 
1.7.9.5

