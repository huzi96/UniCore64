From 3d8371b11f080f471a8ae357fb37a91398dc726a Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Fri, 7 Sep 2012 16:13:19 +0800
Subject: [PATCH 428/641] unicore64: Add pgd_alloc function

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/mm/mmu.c     |    3 ++-
 arch/unicore64/mm/pgtable.c |    9 +++++++--
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/arch/unicore64/mm/mmu.c b/arch/unicore64/mm/mmu.c
index 0fdcc5e..1656141 100644
--- a/arch/unicore64/mm/mmu.c
+++ b/arch/unicore64/mm/mmu.c
@@ -41,7 +41,8 @@ void __init paging_init(void)
 {
 	struct memblock_region *reg;
 
-	/* First 1G for direct-mapped area has been cleared. */
+	/* First 1G for direct-mapped area should be cleared. */
+	swapper_pg_dir[0] = __pgd(0);
 
 	/* Direct map all the memory banks. */
 	for_each_memblock(memory, reg) {
diff --git a/arch/unicore64/mm/pgtable.c b/arch/unicore64/mm/pgtable.c
index 32c10de..a323e16 100644
--- a/arch/unicore64/mm/pgtable.c
+++ b/arch/unicore64/mm/pgtable.c
@@ -1,4 +1,5 @@
 #include <linux/kernel.h>
+#include <linux/sched.h>
 #include <linux/mm.h>
 #include <asm/pgtable.h>
 
@@ -8,8 +9,12 @@
  */
 pgd_t *pgd_alloc(struct mm_struct *mm)
 {
-	/* FIXME */
-	BUG();
+	pgd_t *new_pgd;
+
+	if (new_pgd = (pgd_t *)__get_free_page(GFP_KERNEL))
+		memcpy(new_pgd, swapper_pg_dir, PTRS_PER_PGD * sizeof(pgd_t));
+
+	return new_pgd;
 }
 
 /**
-- 
1.7.9.5

