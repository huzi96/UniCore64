From 2a831a9dcc135bc67eb1762611e4f19d13344649 Mon Sep 17 00:00:00 2001
From: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
Date: Thu, 11 Oct 2012 21:58:37 +0800
Subject: [PATCH 433/641] UniCore64: Add cmpxchg and xchg

Signed-off-by: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
---
 arch/unicore64/include/asm/Kbuild    |    1 -
 arch/unicore64/include/asm/cmpxchg.h |   22 ++++++++++++++++++++++
 2 files changed, 22 insertions(+), 1 deletion(-)
 create mode 100644 arch/unicore64/include/asm/cmpxchg.h

diff --git a/arch/unicore64/include/asm/Kbuild b/arch/unicore64/include/asm/Kbuild
index fdc886d..7fa4c2e 100644
--- a/arch/unicore64/include/asm/Kbuild
+++ b/arch/unicore64/include/asm/Kbuild
@@ -8,7 +8,6 @@ generic-y += bugs.h
 generic-y += cache.h
 generic-y += cacheflush.h
 generic-y += checksum.h
-generic-y += cmpxchg.h
 generic-y += cmpxchg-local.h
 generic-y += cputime.h
 generic-y += current.h
diff --git a/arch/unicore64/include/asm/cmpxchg.h b/arch/unicore64/include/asm/cmpxchg.h
new file mode 100644
index 0000000..1396643
--- /dev/null
+++ b/arch/unicore64/include/asm/cmpxchg.h
@@ -0,0 +1,22 @@
+#ifndef __UNICORE64_ASM_CMPXCHG_H__
+#define __UNICORE64_ASM_CMPXCHG_H__
+
+#ifndef CONFIG_SMP
+#include <asm-generic/cmpxchg.h>
+#else
+#include <arch/asm-debug.h>
+
+#define cmpxchg(ptr, o, n)			\
+	({					\
+		uc64_debug_putx(0xdead0021);	\
+		(*ptr);				\
+	})
+
+#define xchg(ptr, x)				\
+	({					\
+		uc64_debug_putx(0xdead0022);	\
+		(*ptr);				\
+	})
+#endif /* CONFIG_SMP */
+
+#endif /* __UNICORE64_ASM_CMPXCHG_H__ */
-- 
1.7.9.5

