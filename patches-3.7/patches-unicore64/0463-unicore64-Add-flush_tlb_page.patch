From 8a2086d82a25bf2ed426e62a6d7a4a443d8997f8 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Fri, 2 Nov 2012 14:30:46 +0800
Subject: [PATCH 463/641] unicore64: Add flush_tlb_page

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/include/arch/asm-mmuops.h |    8 ++++++++
 arch/unicore64/mm/tlb.c                  |    7 +++++--
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/arch/unicore64/include/arch/asm-mmuops.h b/arch/unicore64/include/arch/asm-mmuops.h
index f5d2f9e..259614d 100644
--- a/arch/unicore64/include/arch/asm-mmuops.h
+++ b/arch/unicore64/include/arch/asm-mmuops.h
@@ -40,6 +40,14 @@ __ASMMACRO_WRAP(.macro	__invalid_tlb;
 #define __invalid_tlb()				__asm__("__invalid_tlb")
 #define __flush_dcache()			__asm__("__flush_dcache")
 
+__ASMMACRO_WRAP(.macro	__invalid_itlb_by_va, rva;
+			movc	p0.c5, &rva, #20;
+		.endm)
+
+__ASMMACRO_WRAP(.macro	__invalid_dtlb_by_va, rva;
+			movc	p0.c5, &rva, #12;
+		.endm)
+
 /**
  * DOC: ASM_MMUOPS_H_SET_PGD
  * __set_pgd -  set pgd address
diff --git a/arch/unicore64/mm/tlb.c b/arch/unicore64/mm/tlb.c
index 9c46e62..2181697 100644
--- a/arch/unicore64/mm/tlb.c
+++ b/arch/unicore64/mm/tlb.c
@@ -19,8 +19,11 @@ void flush_tlb_mm(struct mm_struct *mm)
  */
 void flush_tlb_page(struct vm_area_struct *vma, unsigned long va)
 {
-	/* FIXME */
-	BUG();
+	__asm__ __volatile__(
+			"__invalid_itlb_by_va	%0\n"
+			"__invalid_dtlb_by_va	%0\n"
+			: : "r" (va)
+			: "memory", "cc");
 }
 
 
-- 
1.7.9.5

