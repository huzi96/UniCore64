From 0b447a144b7504bf61d78b9b965b8856b5597af4 Mon Sep 17 00:00:00 2001
From: Liang Rongrong <liangrongrong@mprc.pku.edu.cn>
Date: Mon, 19 Nov 2012 14:40:42 +0800
Subject: [PATCH 467/641] UniCore64: Add the definition of initrd_start and
 initrd_end

Signed-off-by: Liang Rongrong <liangrongrong@mprc.pku.edu.cn>
---
 arch/unicore64/include/arch/hwdef-memory.h |    3 +++
 arch/unicore64/mm/init.c                   |   16 ++++++++++++++--
 2 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/arch/unicore64/include/arch/hwdef-memory.h b/arch/unicore64/include/arch/hwdef-memory.h
index 213eab7..5af0769 100644
--- a/arch/unicore64/include/arch/hwdef-memory.h
+++ b/arch/unicore64/include/arch/hwdef-memory.h
@@ -72,6 +72,9 @@
 #define UC64_PM_ZIMAGE_STACKTOP		__BC(00000000, 03800000)
 #define UC64_PM_ZIMAGE_HEAP_END		__BC(00000000, 03f00000)
 
+#define UC64_PM_INITRD_START		__BC(00000000, 01000000)
+#define UC64_PM_INITRD_SIZE		__BC(00000000, 01000000)
+
 /*
  * Address space: 00400000 - 00408000
  *
diff --git a/arch/unicore64/mm/init.c b/arch/unicore64/mm/init.c
index 25311f1..4910156 100644
--- a/arch/unicore64/mm/init.c
+++ b/arch/unicore64/mm/init.c
@@ -1,10 +1,13 @@
 #include <linux/kernel.h>
 #include <linux/memblock.h>
 #include <linux/bootmem.h>
+#include <linux/initrd.h>
 
 #include <asm/sections.h>
 #include <asm/setup_arch.h>
 
+#include <arch/hwdef-memory.h>
+
 /**
  * mem_init() - release free pages to the buddy allocator
  * Returns the number of pages actually released.
@@ -48,8 +51,7 @@ void free_initmem(void)
 #ifdef CONFIG_BLK_DEV_INITRD
 void free_initrd_mem(unsigned long start, unsigned long end)
 {
-	/* FIXME */
-	BUG();
+	totalram_pages += __free_area(start, end);
 }
 #endif
 
@@ -73,6 +75,16 @@ static void __init memblock_init(void)
 	/* Reserve the page tables. */
 	memblock_reserve(__pa(swapper_pg_dir), PAGE_SIZE);
 
+#ifdef CONFIG_BLK_DEV_INITRD
+	if (UC64_PM_INITRD_SIZE) {
+		memblock_reserve(UC64_PM_INITRD_START, UC64_PM_INITRD_SIZE);
+
+		/* Now convert initrd to virtual addresses */
+		initrd_start = (unsigned long)__va(UC64_PM_INITRD_START);
+		initrd_end = initrd_start + UC64_PM_INITRD_SIZE;
+	}
+#endif
+
 	memblock_allow_resize();
 	memblock_dump_all();
 }
-- 
1.7.9.5

