From 9b719bd6e33a1889d79ed7bd2a6852a98d425cd4 Mon Sep 17 00:00:00 2001
From: Liu Guoli <liuguoli@mprc.pku.edu.cn>
Date: Mon, 19 Nov 2012 15:53:07 +0800
Subject: [PATCH 472/641] UniCore64: Add do_notify_resume

Signed-off-by: Liu Guoli <liuguoli@mprc.pku.edu.cn>
---
 arch/unicore64/kernel/entry.S  |   14 ++++++++++++++
 arch/unicore64/kernel/signal.c |   12 ++++++++++++
 2 files changed, 26 insertions(+)

diff --git a/arch/unicore64/kernel/entry.S b/arch/unicore64/kernel/entry.S
index c32864b..7794d5d 100644
--- a/arch/unicore64/kernel/entry.S
+++ b/arch/unicore64/kernel/entry.S
@@ -63,6 +63,13 @@ ENTRY(ret_from_fork)
 	cmpsub.a	r0, #0
 	adr		lr, 1001b
 	bne		schedule		@ return to 1001b
+	and		r1, r18, #(1 << TIF_NOTIFY_RESUME | 1 << TIF_SIGPENDING)
+	cmpsub.a	r1, #0
+	dmov		r0, sp			@ 'regs'
+	dmov		r2, #0			@ 'syscall'
+	bne.l		do_notify_resume
+	__thread_info	r17
+	ldw		r18, [r17+], #THREAD_INFO_FLAGS
 	cmpsub.a	r18, #0
 	bne		__vec_invalid		@ print error information
 	__context_restore
@@ -121,6 +128,13 @@ ret_syscall:
 	cmpsub.a	r0, #0
 	adr		lr, ret_syscall
 	bne		schedule
+	and		r1, r18, #(1 << TIF_NOTIFY_RESUME | 1 << TIF_SIGPENDING)
+	cmpsub.a	r1, #0
+	dmov		r0, sp			@ 'regs'
+	dmov		r2, #0			@ 'syscall'
+	bne.l		do_notify_resume
+	__thread_info	r17
+	ldw		r18, [r17+], #THREAD_INFO_FLAGS
 	cmpsub.a	r18, #0
 	bne		__vec_invalid		@ print error information
 	__context_restore
diff --git a/arch/unicore64/kernel/signal.c b/arch/unicore64/kernel/signal.c
index 03d5d9c..2fd8a2d1 100644
--- a/arch/unicore64/kernel/signal.c
+++ b/arch/unicore64/kernel/signal.c
@@ -1,4 +1,5 @@
 #include <linux/syscalls.h>
+#include <linux/tracehook.h>
 
 SYSCALL_DEFINE3(sigaltstack, const stack_t __user *, uss,
 		stack_t __user *, uoss,	struct pt_regs *, regs)
@@ -11,3 +12,14 @@ SYSCALL_DEFINE1(rt_sigreturn, struct pt_regs *, regs)
 	BUG();
 }
 
+asmlinkage void do_notify_resume(struct pt_regs *regs,
+		unsigned int thread_flags, int syscall)
+{
+	if (thread_flags & (1 << TIF_SIGPENDING))
+		BUG();
+
+	if (thread_flags & (1 << TIF_NOTIFY_RESUME)) {
+		clear_thread_flag(TIF_NOTIFY_RESUME);
+		tracehook_notify_resume(regs);
+	}
+}
-- 
1.7.9.5

