From 667bd22664cccabff8a283a18bf8d40c6da218c3 Mon Sep 17 00:00:00 2001
From: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
Date: Sat, 15 Dec 2012 15:31:49 +0800
Subject: [PATCH 493/641] unicore64: Add atomic_add_return and
 atomic_sub_return

Signed-off-by: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
---
 arch/unicore64/include/asm/atomic.h |   46 +++++++++++++++++++++++++++--------
 1 file changed, 36 insertions(+), 10 deletions(-)

diff --git a/arch/unicore64/include/asm/atomic.h b/arch/unicore64/include/asm/atomic.h
index df6d814..4ccdbf7 100644
--- a/arch/unicore64/include/asm/atomic.h
+++ b/arch/unicore64/include/asm/atomic.h
@@ -1,24 +1,50 @@
 #ifndef __UNICORE64_ASM_ATOMIC_H__
 #define __UNICORE64_ASM_ATOMIC_H__
 
+#include <asm/barrier.h>
+
 #include <arch/asm-debug.h>
 
 #ifdef CONFIG_SMP
 #ifndef atomic_add_return
-#define atomic_add_return(i, v)		\
-	({					\
-		(v)->counter += i;		\
-		uc64_debug_putx(0xdead0011);	\
-		0;				\
+#define atomic_add_return(i, v)					\
+	({								\
+		unsigned long tmp;					\
+		int result;						\
+		smp_mb();						\
+		__asm__ __volatile__(					\
+			"1:	llw		%0, [%2+], #0\n"	\
+			"	add		%0, %0, %3\n"		\
+			"	mov		%1, %0\n"		\
+			"	scw		%1, [%2+], #0\n"	\
+			"	cmpsub.a	%1, #0\n"		\
+			"	beq		1b"			\
+			: "=&r" (result), "=&r" (tmp)			\
+			: "r" (&(v)->counter), "r" (i)			\
+			: "cc", "memory");				\
+		smp_mb();						\
+		result;							\
 	})
 #endif
 
 #ifndef atomic_sub_return
-#define atomic_sub_return(i, v)		\
-	({					\
-		(v)->counter -= i;		\
-		uc64_debug_putx(0xdead0012);	\
-		0;				\
+#define atomic_sub_return(i, v)					\
+	({								\
+		unsigned long tmp;					\
+		int result;						\
+		smp_mb();						\
+		__asm__ __volatile__(					\
+			"1:	llw		%0, [%2+], #0\n"	\
+			"	sub		%0, %0, %3\n"		\
+			"	mov		%1, %0\n"		\
+			"	scw		%1, [%2+], #0\n"	\
+			"	cmpsub.a	%1, #0\n"		\
+			"	beq		1b"			\
+			: "=&r" (result), "=&r" (tmp)			\
+			: "r" (&(v)->counter), "r" (i)			\
+			: "cc", "memory");				\
+		smp_mb();						\
+		result;							\
 	})
 #endif
 
-- 
1.7.9.5

