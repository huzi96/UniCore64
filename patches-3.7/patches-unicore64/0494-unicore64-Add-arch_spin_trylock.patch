From 0329d92b7041806a781f484f8dba85937d065919 Mon Sep 17 00:00:00 2001
From: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
Date: Sat, 15 Dec 2012 15:55:13 +0800
Subject: [PATCH 494/641] unicore64: Add arch_spin_trylock

Signed-off-by: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
---
 arch/unicore64/include/asm/spinlock.h |   26 ++++++++++++++++++++------
 1 file changed, 20 insertions(+), 6 deletions(-)

diff --git a/arch/unicore64/include/asm/spinlock.h b/arch/unicore64/include/asm/spinlock.h
index 9dadcd1..59b9633 100644
--- a/arch/unicore64/include/asm/spinlock.h
+++ b/arch/unicore64/include/asm/spinlock.h
@@ -47,12 +47,26 @@ static inline void arch_spin_unlock(arch_spinlock_t *lock)
 
 static inline int arch_spin_trylock(arch_spinlock_t *lock)
 {
-	/* FIXME */
-	__asm__(
-		"dmovl r0, 0xdead0003\n\t"
-		"call uc64_debug_putx\n\t"
-	);
-	return 0;
+	u32 tmp;
+
+	__asm__ __volatile__(
+		"	llw		%0, [%1+], #0\n"
+		"	cmpsub.a	%0, #0\n"
+		"	bne		1f\n"
+		"	mov		%0, %2\n"
+		"	scw		%0, [%1+], #0\n"
+		"	sub		%0, %0, #1\n"
+		"1:"
+		: "=&r" (tmp)
+		: "r" (&lock->lock), "r" (LOCK_TOKEN)
+		: "cc", "memory");
+
+	if (tmp == 0) {
+		smp_mb();
+		return 1;
+	} else {
+		return 0;
+	}
 }
 
 static inline void arch_read_lock(arch_rwlock_t *rw)
-- 
1.7.9.5

