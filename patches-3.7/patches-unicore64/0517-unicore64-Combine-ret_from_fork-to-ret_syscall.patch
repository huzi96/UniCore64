From 0d066dacd02a8fd9f42c8b19576e1cd9dcf43407 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Mon, 31 Dec 2012 17:26:44 +0800
Subject: [PATCH 517/641] unicore64: Combine ret_from_fork to ret_syscall

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/kernel/entry.S |   20 ++------------------
 1 file changed, 2 insertions(+), 18 deletions(-)

diff --git a/arch/unicore64/kernel/entry.S b/arch/unicore64/kernel/entry.S
index bd0677a..ac9b7d3 100644
--- a/arch/unicore64/kernel/entry.S
+++ b/arch/unicore64/kernel/entry.S
@@ -74,29 +74,13 @@
  */
 ENTRY(ret_from_fork)
 	call		schedule_tail
-1001:	__irq_disable
-	__thread_info	r17
-	ldw		r18, [r17+], #THREAD_INFO_FLAGS
-	and		r0, r18, #(1 << TIF_NEED_RESCHED)	@ FIXME: wait for and.a
-	cmpsub.a	r0, #0
-	adr		lr, 1001b
-	bne		schedule		@ return to 1001b
-	and		r0, r18, #(1 << TIF_NOTIFY_RESUME | 1 << TIF_SIGPENDING)
-	cmpsub.a	r0, #0
-	dmov		r1, #0			@ 'syscall'
-	bne.l		do_notify_resume
-	__thread_info	r17
-	ldw		r18, [r17+], #THREAD_INFO_FLAGS
-	cmpsub.a	r18, #0
-	bne		__vec_invalid		@ print error information
-	__context_restore
-	eret
+	b		ret_syscall
 ENDPROC(ret_from_fork)
 
 ENTRY(ret_from_kthread)
 	call		schedule_tail
 	dmov		r0, r17
-	adr		lr, 1001b
+	adr		lr, ret_syscall
 	jump		r18
 ENDPROC(ret_from_kthread)
 
-- 
1.7.9.5

