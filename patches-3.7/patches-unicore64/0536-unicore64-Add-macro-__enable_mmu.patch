From 8b5bd3fc05ebca4fe8a278c06b7421cfe8ebbacf Mon Sep 17 00:00:00 2001
From: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
Date: Thu, 10 Jan 2013 10:13:00 +0800
Subject: [PATCH 536/641] unicore64: Add macro __enable_mmu

Signed-off-by: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
---
 arch/unicore64/include/arch/head-macros.S |   12 ++++++++++++
 arch/unicore64/kernel/head.S              |    7 +------
 2 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/arch/unicore64/include/arch/head-macros.S b/arch/unicore64/include/arch/head-macros.S
index 6a2f15e..05c89df 100644
--- a/arch/unicore64/include/arch/head-macros.S
+++ b/arch/unicore64/include/arch/head-macros.S
@@ -56,3 +56,15 @@
 #endif
 	movc		p0.c1, r16, #0;
 .endm
+
+/*
+ * __enable_mmu - enable MMU
+ */
+.macro	__enable_mmu
+	movc		r16, CP0_CTRLREG, #0
+	dor		r16, r16, #CP0_CTRLREG_MMU
+#ifdef	CONFIG_ALIGNMENT_TRAP
+	dor		r16, r16, #CP0_CTRLREG_ALIGN
+#endif
+	movc		CP0_CTRLREG, r16, #0
+.endm
diff --git a/arch/unicore64/kernel/head.S b/arch/unicore64/kernel/head.S
index 856c3a6..277ea92 100644
--- a/arch/unicore64/kernel/head.S
+++ b/arch/unicore64/kernel/head.S
@@ -41,12 +41,7 @@ ENTRY(stext)
 
 	__invalid_tlb
 
-	movc		r0, CP0_CTRLREG, #0
-	dor		r0, r0, #CP0_CTRLREG_MMU
-#ifdef	CONFIG_ALIGNMENT_TRAP
-	dor		r0, r0, #CP0_CTRLREG_ALIGN
-#endif
-	movc		CP0_CTRLREG, r0, #0
+	__enable_mmu
 
 	ldd		sp, __priv_sp
 
-- 
1.7.9.5

