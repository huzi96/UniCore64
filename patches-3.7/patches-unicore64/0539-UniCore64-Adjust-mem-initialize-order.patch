From 52e7343ebf602585df3f11ae1cfbb1b016911193 Mon Sep 17 00:00:00 2001
From: Zhang Mengchi <zhangmengchi@mprc.pku.edu.cn>
Date: Thu, 30 May 2013 08:55:34 +0800
Subject: [PATCH 539/641] UniCore64: Adjust mem initialize order

Signed-off-by: Zhang Mengchi <zhangmengchi@mprc.pku.edu.cn>
---
 arch/unicore64/boot/unicore64-fpga.dts |    2 +-
 arch/unicore64/mm/init.c               |    7 ++++++-
 arch/unicore64/mm/mmu.c                |    4 ----
 3 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/arch/unicore64/boot/unicore64-fpga.dts b/arch/unicore64/boot/unicore64-fpga.dts
index d24c364..1e3e404 100644
--- a/arch/unicore64/boot/unicore64-fpga.dts
+++ b/arch/unicore64/boot/unicore64-fpga.dts
@@ -12,6 +12,6 @@
 	 */
 	memory {
 		device_type = "memory";
-		reg = <0 0x04000000>;
+		reg = <0 0x20000000>;
 	};
 };
diff --git a/arch/unicore64/mm/init.c b/arch/unicore64/mm/init.c
index 9bf230f..cb0509f 100644
--- a/arch/unicore64/mm/init.c
+++ b/arch/unicore64/mm/init.c
@@ -63,6 +63,11 @@ static void __init zone_sizes_init(void)
 
 	/* Initialize mem_map[] */
 	free_area_init(zone_sizes);
+
+	/* Initialize the zero page. */
+	memset((void *)UC64_VM_ZEROPAGE, 0, PAGE_SIZE);
+	empty_zero_page = virt_to_page(UC64_VM_ZEROPAGE);
+
 }
 
 static void __init memblock_init(void)
@@ -102,6 +107,6 @@ void __init setup_arch_memory(void)
 {
 	memblock_init();
 	max_pfn_init();
-	zone_sizes_init();
 	paging_init();
+	zone_sizes_init();
 }
diff --git a/arch/unicore64/mm/mmu.c b/arch/unicore64/mm/mmu.c
index 6426dbd..56563cc 100644
--- a/arch/unicore64/mm/mmu.c
+++ b/arch/unicore64/mm/mmu.c
@@ -75,10 +75,6 @@ void __init paging_init(void)
 
 	uc64_create_io_direct_mapping();
 
-	/* Initialize the zero page. */
-	memset((void *)UC64_VM_ZEROPAGE, 0, PAGE_SIZE);
-	empty_zero_page = virt_to_page(UC64_VM_ZEROPAGE);
-
 }
 
 /**
-- 
1.7.9.5

