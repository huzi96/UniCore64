From b87996cbe9365dfcb377e250daeb8c8fe92cea3c Mon Sep 17 00:00:00 2001
From: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
Date: Mon, 17 Jun 2013 19:27:40 +0800
Subject: [PATCH 553/641] unicore64: Send call function ipi

Signed-off-by: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
---
 arch/unicore64/Kconfig           |    1 +
 arch/unicore64/include/asm/smp.h |    3 +++
 arch/unicore64/kernel/smp.c      |   20 ++++----------------
 3 files changed, 8 insertions(+), 16 deletions(-)

diff --git a/arch/unicore64/Kconfig b/arch/unicore64/Kconfig
index d34544c..8eace9f 100644
--- a/arch/unicore64/Kconfig
+++ b/arch/unicore64/Kconfig
@@ -11,6 +11,7 @@ config UNICORE64
 	select GENERIC_KERNEL_THREAD
 	select GENERIC_KERNEL_EXECVE
 	select GENERIC_SMP_IDLE_THREAD
+	select USE_GENERIC_SMP_HELPERS if SMP
 	select OF
 	select OF_EARLY_FLATTREE
 	select NO_BOOTMEM
diff --git a/arch/unicore64/include/asm/smp.h b/arch/unicore64/include/asm/smp.h
index 7cb7ac1..a9dc6ca 100644
--- a/arch/unicore64/include/asm/smp.h
+++ b/arch/unicore64/include/asm/smp.h
@@ -9,4 +9,7 @@
 
 #define raw_smp_processor_id() (current_thread_info()->cpu)
 
+extern void arch_send_call_function_ipi_mask(const struct cpumask *mask);
+extern void arch_send_call_function_single_ipi(int cpu);
+
 #endif /* __UNICORE64_ASM_SMP_H__ */
diff --git a/arch/unicore64/kernel/smp.c b/arch/unicore64/kernel/smp.c
index 7ab8aeb..95de64e 100644
--- a/arch/unicore64/kernel/smp.c
+++ b/arch/unicore64/kernel/smp.c
@@ -82,26 +82,14 @@ void smp_send_reschedule(int cpu)
 	send_ipi_message(cpumask_of(cpu), IPI_RESCHEDULE);
 }
 
-int smp_call_function(smp_call_func_t func, void *info, int wait)
+void arch_send_call_function_ipi_mask(const struct cpumask *mask)
 {
-	/* FIXME */
-	BUG();
-	return 0;
+	send_ipi_message(mask, IPI_CALL_FUNC);
 }
 
-void smp_call_function_many(const struct cpumask *mask, smp_call_func_t func,
-				void *info, bool wait)
+void arch_send_call_function_single_ipi(int cpu)
 {
-	/* FIXME */
-	BUG();
-}
-
-int smp_call_function_single(int cpuid, smp_call_func_t func, void *info,
-				int wait)
-{
-	/* FIXME */
-	BUG();
-	return 0;
+	send_ipi_message(cpumask_of(cpu), IPI_CALL_FUNC_SINGLE);
 }
 
 void __init smp_cpus_done(unsigned int max_cpus)
-- 
1.7.9.5

