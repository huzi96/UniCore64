From 2e2ce30ffdeebbd313003776fb6f7d38d5f9451a Mon Sep 17 00:00:00 2001
From: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
Date: Fri, 31 May 2013 16:39:34 +0800
Subject: [PATCH 554/641] unicore64: Disable and clear ipi

Signed-off-by: Chang Huaixin <changhuaixin@mprc.pku.edu.cn>
---
 arch/unicore64/include/arch/hwdef-cp0-sysctrl.h |    1 +
 arch/unicore64/kernel/smp.c                     |    5 +++++
 2 files changed, 6 insertions(+)

diff --git a/arch/unicore64/include/arch/hwdef-cp0-sysctrl.h b/arch/unicore64/include/arch/hwdef-cp0-sysctrl.h
index 85ad77b..0698eb9 100644
--- a/arch/unicore64/include/arch/hwdef-cp0-sysctrl.h
+++ b/arch/unicore64/include/arch/hwdef-cp0-sysctrl.h
@@ -56,6 +56,7 @@
 #define CP0_INTR_IK3			__BF(1, 1, 11)
 #define CP0_INTR_IK4			__BF(1, 1, 12)
 #define CP0_INTR_IPM			__BF(1, 1, 13)
+#define CP0_INTR_SMP			__BF(1, 4, 9)
 
 /**
  * DOC: HWDEF_CP0_SYSCTRL_H_CP0_CTRLREG
diff --git a/arch/unicore64/kernel/smp.c b/arch/unicore64/kernel/smp.c
index 95de64e..2c0519e 100644
--- a/arch/unicore64/kernel/smp.c
+++ b/arch/unicore64/kernel/smp.c
@@ -6,6 +6,11 @@
 
 #include <arch/hwdef-cp0-sysctrl.h>
 
+#define __ipi_disable()	\
+	__write_uc64(__read_uc64(asr) | ASR_INTR_SMP)
+#define __ipi_clear()		\
+	__write_cp(__read_cp(CP0_INTR) & ~CP0_INTR_SMP, CP0_INTR)
+
 /* A collection of single bit ipi messages.  */
 static struct {
 	unsigned long bits ____cacheline_aligned;
-- 
1.7.9.5

