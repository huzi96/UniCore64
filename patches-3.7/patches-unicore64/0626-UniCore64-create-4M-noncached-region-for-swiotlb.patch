From c71555a767642fdb4c88506296f2750eeaf90447 Mon Sep 17 00:00:00 2001
From: Guan Xuetao <gxt@mprc.pku.edu.cn>
Date: Tue, 13 May 2014 23:56:01 +0800
Subject: [PATCH 626/641] UniCore64: create 4M noncached region for swiotlb

Signed-off-by: Guan Xuetao <gxt@mprc.pku.edu.cn>
---
 arch/unicore64/include/arch/hwdef-memory.h |    2 ++
 arch/unicore64/include/asm/pgtable-prot.h  |    7 +++++++
 arch/unicore64/mm/init.c                   |    6 ++++++
 arch/unicore64/mm/mmu.c                    |    3 +++
 5 files changed, 34 insertions(+)

diff --git a/arch/unicore64/include/arch/hwdef-memory.h b/arch/unicore64/include/arch/hwdef-memory.h
index 213eab7..2692986 100644
--- a/arch/unicore64/include/arch/hwdef-memory.h
+++ b/arch/unicore64/include/arch/hwdef-memory.h
@@ -95,6 +95,7 @@
  * PGTABLE_PMD_*:
  * Physical address of the direct map pmd.
  */
+#define UC64_PM_NONCACHED_START		__BC(00000000, 00000000)
 #define UC64_PM_KIMAGE_START		__BC(00000000, 00408000)
 #define UC64_PM_DTB_START		__BC(00000000, 00400000)
 #define UC64_PM_ZEROPAGE		__BC(00000000, 00403000)
@@ -105,6 +106,7 @@
 
 #define UC64_PM2VM(paddr)		(UC64_VM_DMAP_START + (paddr))
 
+#define UC64_VM_NONCACHED_START		UC64_PM2VM(UC64_PM_NONCACHED_START)
 #define UC64_VM_KIMAGE_START		UC64_PM2VM(UC64_PM_KIMAGE_START)
 #define UC64_VM_PGTABLE_PGD		UC64_PM2VM(UC64_PM_PGTABLE_PGD)
 #define UC64_VM_ZEROPAGE		UC64_PM2VM(UC64_PM_ZEROPAGE)
diff --git a/arch/unicore64/include/asm/pgtable-prot.h b/arch/unicore64/include/asm/pgtable-prot.h
index c70b4bd..b3258c3 100644
--- a/arch/unicore64/include/asm/pgtable-prot.h
+++ b/arch/unicore64/include/asm/pgtable-prot.h
@@ -13,6 +13,13 @@
 #define arch_vm_get_page_prot(vm_flags) __pgprot(UC64_PTE_EXIST \
 		| UC64_PTE_TYPE_CACHE | UC64_PTE_USER | UC64_PTE_SHARE)
 
+/*
+ * Mark the prot value as uncacheable.
+ * NOTE: the same setting method for PTE and PMD.
+ */
+#define pgprot_noncached(prot)		\
+	__pgprot((pgprot_val(prot) & ~UC64_PTE_TYPE_SELECT) | UC64_PTE_TYPE_NOCACHE)
+
 #define __P000		__pgprot(0)
 #define __P001		__pgprot(UC64_PTE_READ)
 #define __P010		__pgprot(0)
diff --git a/arch/unicore64/mm/init.c b/arch/unicore64/mm/init.c
index b86f990..1d1e837 100644
--- a/arch/unicore64/mm/init.c
+++ b/arch/unicore64/mm/init.c
@@ -1,6 +1,7 @@
 #include <linux/kernel.h>
 #include <linux/memblock.h>
 #include <linux/bootmem.h>
+#include <linux/swiotlb.h>
 
 #include <asm/sections.h>
 #include <asm/setup_arch.h>
@@ -74,6 +75,9 @@ static void __init zone_sizes_init(void)
 
 static void __init memblock_init(void)
 {
+	/* Reserve the noncached region with memblock. */
+	memblock_reserve(UC64_PM_NONCACHED_START, SZ_4M);
+
 	/* Reserve the kernel text, kernel data and initrd with memblock. */
 	memblock_reserve(__pa(_text), _end - _text);
 
@@ -111,4 +115,6 @@ void __init setup_arch_memory(void)
 	max_pfn_init();
 	paging_init();
 	zone_sizes_init();
+
+	swiotlb_init(1);
 }
diff --git a/arch/unicore64/mm/mmu.c b/arch/unicore64/mm/mmu.c
index 763a42a..972af89 100644
--- a/arch/unicore64/mm/mmu.c
+++ b/arch/unicore64/mm/mmu.c
@@ -74,6 +74,9 @@ void __init paging_init(void)
 				UC64_PM_PGTABLE_PUD_DM00, UC64_PMD_TYPE_CACHE);
 	}
 
+	/* Set first 4M physical memory as noncached */
+	uc64_create_direct_mapping(UC64_PM_NONCACHED_START, SZ_4M, UC64_PM_PGTABLE_PUD_DM00, 0);
+
 	uc64_create_io_direct_mapping();
 
 	__invalid_tlb();
-- 
1.7.9.5

